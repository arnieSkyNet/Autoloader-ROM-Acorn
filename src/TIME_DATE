Å..........*.......*.......*......*.......*.......*.......*.......*.......*.<; These are the clock routines for all CFS and all machinesSET_INTERNAL_CLOCK	LDA	machine_type			; Get machine type	CMP	#03				; If BBC B or less then	BMI	:no_clock_routine		; no clock available (Yet!)	JSR	UPDATE_CLOCK_MOS_FROM_FS	; Write MOS time from FS 	JSR	SETUP_EVENT_CHIMING		; Setup event timer:no_clock_routine	RTSUPDATE_CLOCK_MOS_FROM_FS	LDA	curr_file_syst			; Get filing system	CMP	#05				; If <> NET then don't	BNE	:not_update_mos_clock		; update masters MOS	JSR	READ_FS_TIME			; Read FS time & date	JSR	WRITE_TIME_INTO_STORE		; Write time & date	JSR	WRITE_CMOS_TIME		; Set new MOS time & date:not_update_mos_clock	RTSCLOCK_TEXT_POSITION        LDA	#26        JSR     OSWRCH        LDA	#31        JSR     OSWRCH         LDA	#28        JSR     OSWRCH         LDA	#16        JSR     OSWRCH        JSR     INVERSE_COLOUR 	RTSWRITE_CMOS_TIME        LDA	#08			; Func code to write CMOS time	STA	time_store	LDX	#>time_store	LDY	#<time_store	LDA	#&0F			; Write CMOS clock OSWORD	JSR	OSWORD	RTSREAD_CMOS_TIME        STA     clock_blk        LDX	#>clock_blk        LDY	#<clock_blk        LDA	#14        JSR     OSWORD 	RTSREAD_FS_TIME	LDA	#0	STA	clock_blk	STA	clock_blk+2	STA	clock_blk+4	LDA	#16	STA	clock_blk+1	STA	clock_blk+3	LDX	#>clock_blk	LDY	#<clock_blk	LDA	#&14			; Read FS Date and Time	JSR	UTILITY_OSWORD_COMMAND	RTSPRINT_FS_DATE	LDA	clock_blk+4             ; Get date	JSR	PRINT_NUMBER	LDA	#"/"			; Get "/"	JSR	OSWRCH	LDA	clock_blk+5		; Get Month/Year	AND	#&0F			; Mask off low 4 bits for month	JSR	PRINT_NUMBER	LDA	#"/"			; Get "/"	JSR	OSWRCH;:continue_year	LDA	clock_blk+5		; Get Month/Year	AND	#&F0			; Mask off top 4 bits for year        CLC	ADC	#81			; Add 81 years to get actual year	JSR	PRINT_NUMBER	RTSWRITE_FS_TIME_AND_DATE	JSR	PRINT_FS_DATE	LDA	#" "			; Get " "	JSR	OSWRCH	JSR	OSWRCH	JSR	WRITE_TIME_INTO_STORE	LDX	#>time_store	LDY	#<time_store	INX	JSR	PRINT_TEXT		LDA	#" "	JSR	OSWRCH	LDA	#"*"	JSR	OSWRCH	JSR	OSWRCH	JSR	DEFAULT_COLOUR	RTSDISPLAY_DATE_TIME	LDA	machine_type	CMP	#02	BPL	:master_compact	LDA	curr_file_syst	CMP	#5	BNE	:not_econet	JSR	READ_FS_TIME	JSR	CLOCK_TEXT_POSITION        JSR	INVERSE_COLOUR	LDA	#"*"	JSR	OSWRCH	JSR	OSWRCH	LDA	#" "	JSR	OSWRCH	JSR	WRITE_FS_TIME_AND_DATE	JMP	:no_alarm:not_econet	JSR	CLOCK_TEXT_POSITION	LDX	#>time_unavailable	LDY	#<time_unavailable	JSR	PRINT_TEXT	JMP	:no_alarm:master_compact	LDA	#0	JSR     READ_CMOS_TIME        LDA	#&FF         STA     clock_blk+24        LDA	#32        STA     clock_blk+3         STA     clock_blk+15 	JSR	CLOCK_TEXT_POSITION        LDX	#>clock_blk        LDY	#<clock_blk        JSR     PRINT_TEXT         JSR     DEFAULT_COLOUR 	LDA	#01	JSR     READ_CMOS_TIME	LDA	clock_blk+6	CMP	#0			; Check for zero seconds	BEQ	:no_alarm        LDX	#>clock_blk        LDY	#<clock_blk	LDA	#&03	JSR	OSWORD	LDA	clock_blk+1	CMP	#&FF	BEQ	:no_alarm	LDX	#>clock_par	LDY	#<clock_par		LDA	#&04	JSR	OSWORD:no_alarm        RTSCHECK_TIME_FOR_CHIME	LDA	text_pos	PHA	LDA	text_pos+1	PHA	LDA	text_pos+2	PHA	LDA	text_pos+3	PHA	JSR	GET_TEXT_POSITION	JSR	DISPLAY_DATE_TIME	LDA	#01	JSR	READ_CMOS_TIME	LDA	clock_blk+5	; Check minutes is O'clock	CMP	#00		BNE	:not_oclock	; Not O'clock so jump to check half hour	LDA	clock_blk+6		; Get seconds to check if zero.	BNE	:not_time_for_chime	JSR	CHIME_PART_1	JSR	CHIME_PART_2	JMP	:not_time_for_chime:not_oclock	CMP	#&30    	; Check minutes for half past the hour	BNE	:not_time_for_chime	LDA	clock_blk+6		; Get seconds to check if zero	BNE	:not_time_for_chime	JSR	CHIME_PART_1:not_time_for_chime	LDX	#>load_address	LDY	#<load_address	JSR	PRINT_TEXT	PLA	STA	text_pos+3	PLA	STA	text_pos+2	PLA		STA	text_pos+1	PLA	STA	text_pos	RTSWRITE_TIME_INTO_STORE	LDA	#00			; Func code to write CMOS time	STA	time_store	LDX	#>time_store	LDY	#<time_store	LDA	#14			; Write CMOS clock OSWORD	JSR	OSWORD	LDA	clock_blk+6		; Get hours			LDY	#01	JSR	STORE_NUMBER		; Store Hours 1 and 2	LDA	clock_blk+7		; Get minutes			LDY	#04	JSR	STORE_NUMBER		; Store Minutes 1 and 2	LDA	clock_blk+8		; Get seconds	LDY	#07	JSR	STORE_NUMBER		; Store Seconds 1 and 2      	LDA	#&FF	STA	time_store+9	RTSSTORE_NUMBER	JSR	CONVERT_ASC	LDA	oscli_store	STA	time_store,Y	INY	LDA	oscli_store+1	STA	time_store,Y	INY	LDA	#":"	STA	time_store,Y	RTS